<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>e-RESOLVE - Login</title>

  <!-- EmailJS -->
  <script src='https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js'></script>
  <script>
    (function(){
      emailjs.init('WbFSQbbLbsut1iO3R'); //  EmailJS Public Key
    })();
  </script>

<style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-height: 100vh;
    }

    #tkiet_banner_id {
      width: 100vw;
      height: 20vh;
    }

    #tkiet_building_id {
      width: 100vw;
      height: 80vh;
      margin: -5px 5px -5px -5px;
      filter: blur(5px);
      display: block;
      position: relative;
      z-index: 1;
    }

    .back-btn {
      position: absolute;
      top: 160px;
      left: 30px;
      z-index: 2;
      background: rgba(255,255,255,0.3);
      color: rgb(0, 0, 0);
      border: 2px solid rgba(255,255,255,0.5);
      padding: 12px 25px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }

    .back-btn:hover {
      transform: translateY(-2px);
    }

    .login-container {
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(15px);
      border-radius: 25px;
      padding: 50px 40px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.2);
      width: 30vw;
      height: 60vh;
      position: relative;
      top: -520px;
      left: 35%;
      z-index: 2;
    }

    .login-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .login-header .icon {
      font-size: 4rem;
      display: block;
    }

    .login-header h2 {
      font-size: 2rem;
      color: #333;
      font-weight: 700;
    }

    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 1rem;
    }

    .form-group input {
      width: 100%;
      padding: 15px 20px;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    .form-group input:disabled {
      background: #f0f0f0;
      cursor: not-allowed;
    }

    .btn {
      width: 100%;
      background-color: #667eea;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 10px 0;
    }

    

    

    .btn-send-otp {
      width: 10vw;
      margin: -30px 0 -10px 208px;
      padding: 5px;
      font-weight: 800;
      background: linear-gradient(135deg, #000000 0%, #b5b5b5 100%);
    }

    .error-message, .success-message {
      width: 20vw;
      height: 10vh;
      padding: 12px 15px;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      position: absolute;
      top: 21%;
      left: 40%;
      z-index: 1000;
      display: none;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      border: 3px solid #fb98a2;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      border: 3px solid #9cffb3;
    }

    .timer {
      text-align: center;
      color: #666;
      margin-top: 10px;
      font-size: 14px;
      font-weight: 600;
    }

    .resend-link {
      text-align: center;
      margin-top: 10px;
    }

    .resend-link button {
      background: none;
      border: none;
      color: #667eea;
      cursor: pointer;
      text-decoration: underline;
      font-size: 14px;
      font-weight: 600;
    }

    .resend-link button:disabled {
      color: #ccc;
      cursor: not-allowed;
    }

    
</style>
</head>

<body>
	<button class='back-btn' onclick='goBack()'>‚Üê Back to Home</button>
	<img id='tkiet_banner_id' src='tkiet_banner.jpg' alt='tkiet banner'>

	<div id='error-message' class='error-message'></div>
	<div id='success-message' class='success-message'></div>

	<img id='tkiet_building_id' src='tkiet_building.webp' alt='tkiet building'>

	<div class='login-container' style='height: 70vh;'>
		<div class='login-header' style='margin: -30px 0 0 0;'>
			<span class='icon' id='login-icon'>üéì</span>
			<h2 id='login-title'>Login</h2>
		</div>

		<form id='login-form' onsubmit='handleLogin(event)'>
			<div class='form-group'>
				<label for='user-id'>Email</label>
				<input type='email' id='user-id' required placeholder='Enter your registered email'>
			</div>
			<button type='button' class='btn btn-send-otp' id='send-otp-btn' onclick='sendOTP()'>
				Send OTP
			</button>
			<div class='form-group'>
				<label for='user-otp'>OTP</label>
				<input type='text' id='user-otp' maxlength='6' required placeholder='Enter 6-digit OTP' >
			</div>
			<div class='resend-link' style='display: none;' id='resend-container'>
				<button type='button' id='resend-btn'  disabled>
					Resend OTP
				</button>
			</div>
			<button type='submit' class='btn' id='login-btn' style='font-weight: 800;' >
				Verify
			</button>
		</form>
	</div>


<script type='module'>
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { 
        getFirestore, collection, doc, setDoc, getDoc, getDocs 
    } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: 'AIzaSyB3jC4rKypCYUc0NhlJa-1kuAkmFGxGS88',
        authDomain: 'e-resolve-tkiet.firebaseapp.com',
        projectId: 'e-resolve-tkiet',
        storageBucket: 'e-resolve-tkiet.firebasestorage.app',
        messagingSenderId: '876305569079',
        appId: '1:876305569079:web:14b890b4704b52e7cfb6b2',
        measurementId: 'G-7SEN34J28J'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const EMAILJS_SERVICE_ID = 'service_nimpvjd'; // EmailJS Service ID
    const EMAILJS_TEMPLATE_ID = 'template_52grcyl'; // EmailJS 

    let generatedOTP = '';
    let otpTimer = null;
    let otpTimeLeft = 300; // 5 minutes
    let resendCount = 0;
    const MAX_RESEND = 3;
    let currentUserType = 'student';

    window.onload = function() {
        const selectedType = localStorage.getItem('selectedUserType') || 'student';
        currentUserType = selectedType;
        updateLoginForm(selectedType);
    };

    async function loginUser(email, selectedType) {

        if (selectedType === 'student') {
            const snap = await getDocs(collection(db, 'students'));
            for (let s of snap.docs) {
                if (s.data().email === email) {
                    return { type: 'student', data: s.data() };
                }
            }
            return null; // no match
        }

        if (selectedType === 'department') {
            const snap = await getDocs(collection(db, 'department'));
            for (let d of snap.docs) {
                if (d.data().email === email) {
                    return { type: 'department', data: d.data() };
                }
            }
            return null;
        }

        if (selectedType === 'hostel') {
            const snap = await getDocs(collection(db, 'hostel'));
            for (let h of snap.docs) {
                if (h.data().email === email) {
                    return { type: 'hostel', data: h.data() };
                }
            }
            return null;
        }

        return null;
    }


    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    window.sendOTP = async function() {
        const email = document.getElementById('user-id').value.trim();
        if (!email) return showMessage('error', 'Please enter email address');

        if (!validateEmail(email)) {
            showMessage('error', 'Please enter a valid email address');
            return;
        }

        hideMessages();
        // const userFirestore = await loginUser(email);
        const userFirestore = await loginUser(email, currentUserType);

        if (!userFirestore) {
            showMessage('error', 'User is not registered');
            return;
        }
        const sendBtn = document.getElementById('send-otp-btn');
        const originalText = sendBtn.textContent;
        sendBtn.textContent = 'Sending...';
        sendBtn.disabled = true;

        try{
        generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();

        await setDoc(doc(db, 'otps', email), {
            otp: generatedOTP,
            timestamp: new Date().toISOString(),
            expiresAt: new Date(Date.now() + 5 * 60 * 1000).toISOString(),
            attempts: 0
        });

        const templateParams = {
            to_email: email,
            to_name: userFirestore.data.name,
            otp_code: generatedOTP,
            expires_in: '5 minutes',
            from_name: 'e-RESOLVE TKIET',
            institution: 'Tatyasaheb Kore Institute of Engineering and Technology'
        };

        // Send email via EmailJS
        // await emailjs.send(
        //     'service_nimpvjd',
        //     'template_52grcyl',
        //     {
        //         to_email: email,
        //         to_name: userFirestore.data.name,
        //         otp_code: generatedOTP,
        //         expires_in: '5 minutes',
        //         from_name: 'e-RESOLVE TKIET',
        //     },
        //     'WbFSQbbLbsut1iO3R'
        // );
        await Promise.race([
            emailjs.send('service_nimpvjd', 'template_52grcyl', templateParams, 'WbFSQbbLbsut1iO3R'),
            new Promise((_, reject) => setTimeout(() => reject('Request timed out'), 15000))
        ]);

        document.getElementById('user-id').disabled = true;
        document.getElementById('user-otp').disabled = false;
        document.getElementById('login-btn').disabled = false;

        showMessage('success', 'OTP sent successfully');
        }
        catch (error) {
        console.error('Error sending OTP:', error);
        showMessage('error', 'Failed to send OTP.');

        // showMessage('error', 'Failed to send OTP. Please check console.');
        }
        finally {
        sendBtn.textContent = originalText;
        sendBtn.disabled = false;
        }
    };

    window.handleLogin = async function(event) {
        event.preventDefault();

        const email = document.getElementById('user-id').value.trim();
        const enteredOTP = document.getElementById('user-otp').value.trim();

            if (!enteredOTP) {
                showMessage('error', 'Please enter the OTP');
                return;
            }

            if (enteredOTP.length !== 6) {
                showMessage('error', 'Please enter a valid 6-digit OTP');
                return;
            }

        hideMessages();
        const loginBtn = document.getElementById('login-btn');
            const originalText = loginBtn.textContent;
            loginBtn.innerHTML = 'Verifying... ';


        try {
        const otpDoc = await getDoc(doc(db, 'otps', email));
        if (!otpDoc.exists()) {
            showMessage('error', 'OTP not found. Please request a new one.');
            loginBtn.textContent = originalText;
            return;
        }

        const otpData = otpDoc.data();
        const expiresAt = new Date(otpData.expiresAt);
        
        // Check if OTP expired
        if (new Date() > expiresAt) {
            showMessage('error', 'OTP has expired. Please request a new one.');
            loginBtn.textContent = originalText;
            // document.getElementById('resend-btn').disabled = false;
            return;
        }

        if (enteredOTP !== otpData.otp) {
            showMessage('error', 'Incorrect OTP');
            return;
        }

        if(enteredOTP === otpData.otp){
            // OTP Verified
            // showMessage('success', ' OTP Verified! Logging in...');
            // const userFirestore = await loginUser(email);
            const userFirestore = await loginUser(email, currentUserType);

            if (userFirestore) {
            const user = userFirestore.data;
            const userType = userFirestore.type;
            

            localStorage.setItem('currentUser', JSON.stringify({
                id: user.studentId || user.userId || email,
                type: userType,
                name: user.name,
                email: user.email,
                phone: user.phone || '',
                department: user.department || '',
                year: user.year || '',
                hostel: user.hostel || '',
                room: user.room || '',
                grNumber: user.grNumber ,
                restrictedUntil: user.restrictedUntil
            }));

            showMessage('success', 'Login successful');

            setTimeout(() => {
                if (userType === 'student') window.location.href = 'student.html';
                if (userType === 'department') window.location.href = 'department.html';
                if (userType === 'hostel') window.location.href = 'hostel.html';
            }, 1500);
            }else {
            showMessage('error', 'Invalid credentials! ');
            }

            await setDoc(doc(db, 'otps', email), { 
            ...otpData, 
            used: true, 
            usedAt: new Date().toISOString() 
            });
        }else {
            // Increment failed attempts
            const attempts = (otpData.attempts || 0) + 1;
            await setDoc(doc(db, 'otps', email), { ...otpData, attempts }, { merge: true });

            if (attempts >= 3) {
            showMessage('error', 'Too many failed attempts. Please request a new OTP.');
            // clearInterval(otpTimer);
            document.getElementById('resend-btn').disabled = false;
            document.getElementById('user-otp').disabled = true;
            } 
            else {
            showMessage('error', `Invalid OTP. ${3 - attempts} attempts remaining.`);
            }
            
            document.getElementById('user-otp').value = '';
            document.getElementById('user-otp').focus();
            loginBtn.textContent = originalText;
            // loginBtn.disabled = false;
        }
        } catch (error) {
                console.error('Error verifying OTP:', error);
                showMessage('error', 'Verification failed. Please try again.');
                loginBtn.textContent = originalText;
                // loginBtn.disabled = false;
            }


        
    };


    function updateLoginForm(type) {
    const icon = document.getElementById('login-icon');
    const title = document.getElementById('login-title');

    switch(type) {
        case 'student':
        icon.textContent = 'üéì';
        icon.className = 'icon student-icon';
        title.textContent = 'Student Login';
        break;
        case 'department':
        icon.textContent = 'üè¢';
        icon.className = 'icon department-icon';
        title.textContent = 'Department Login';
        break;
        case 'hostel':
        icon.textContent = 'üèõÔ∏è';
        icon.className = 'icon hostel-icon';
        title.textContent = 'Hostel Login';
        break;
    }
    }

    function showMessage(type, message) {
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');

        if (type === 'error') {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
        } else {
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
        }
        setTimeout(hideMessages, 3000);
    }

    function hideMessages() {
        document.getElementById('error-message').style.display = 'none';
        document.getElementById('success-message').style.display = 'none';
    }

    window.goBack = function() {
        window.location.href = 'index.html';
    };
</script>

</body>
</html>
    